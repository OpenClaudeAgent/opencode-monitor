#!/bin/bash
#
# OpenCode Usage Daemon
# Fetch usage from Anthropic API every 5 minutes
#

set -u

# Singleton
LOCK_DIR="/tmp/opencode-usaged.lock"
PID_FILE="$LOCK_DIR/pid"

cleanup() {
    rm -rf "$LOCK_DIR"
    exit 0
}

if ! mkdir "$LOCK_DIR" 2>/dev/null; then
    if [[ -f "$PID_FILE" ]]; then
        old_pid=$(cat "$PID_FILE" 2>/dev/null)
        if kill -0 "$old_pid" 2>/dev/null; then
            echo "Already running (PID $old_pid). Exiting."
            exit 1
        fi
    fi
    rm -rf "$LOCK_DIR"
    mkdir "$LOCK_DIR"
fi
echo $$ > "$PID_FILE"
trap cleanup EXIT SIGTERM SIGINT

# Config
STATE_FILE="/tmp/opencode-usage.json"
AUTH_FILE="$HOME/.local/share/opencode/auth.json"
API_URL="https://api.anthropic.com/api/oauth/usage"
FETCH_INTERVAL=300  # 5 minutes

log() {
    echo "[$(date +%H:%M:%S)] $1"
}

write_error_state() {
    local error="$1"
    cat > "$STATE_FILE" <<EOF
{"error":"$error","updated":$(date +%s)}
EOF
}

fetch_usage() {
    # Check auth file
    if [[ ! -f "$AUTH_FILE" ]]; then
        write_error_state "auth_not_found"
        log "Auth file not found"
        return
    fi
    
    # Get token
    local token=$(jq -r '.anthropic.access // empty' "$AUTH_FILE" 2>/dev/null)
    if [[ -z "$token" ]]; then
        write_error_state "token_not_found"
        log "Token not found"
        return
    fi
    
    # Check expiration
    local expires=$(jq -r '.anthropic.expires // 0' "$AUTH_FILE")
    local now_ms=$(($(date +%s) * 1000))
    if [[ $expires -lt $now_ms ]]; then
        write_error_state "token_expired"
        log "Token expired"
        return
    fi
    
    # Fetch usage
    local response=$(curl -s --max-time 10 "$API_URL" \
        -H "Authorization: Bearer $token" \
        -H "anthropic-beta: oauth-2025-04-20" \
        -H "Content-Type: application/json" 2>/dev/null)
    
    # Validate response
    if ! echo "$response" | jq -e '.five_hour' > /dev/null 2>&1; then
        write_error_state "api_error"
        log "API error"
        return
    fi
    
    # Parse data
    local five_hour_util=$(echo "$response" | jq -r '.five_hour.utilization // 0' | cut -d. -f1)
    local five_hour_reset=$(echo "$response" | jq -r '.five_hour.resets_at // null')
    local seven_day_util=$(echo "$response" | jq -r '.seven_day.utilization // 0' | cut -d. -f1)
    local seven_day_reset=$(echo "$response" | jq -r '.seven_day.resets_at // null')
    
    # Quote dates if not null
    [[ "$five_hour_reset" != "null" ]] && five_hour_reset="\"$five_hour_reset\""
    [[ "$seven_day_reset" != "null" ]] && seven_day_reset="\"$seven_day_reset\""
    
    # Write state
    cat > "$STATE_FILE" <<EOF
{"five_hour":{"utilization":$five_hour_util,"resets_at":$five_hour_reset},"seven_day":{"utilization":$seven_day_util,"resets_at":$seven_day_reset},"updated":$(date +%s),"error":null}
EOF
    
    log "Usage updated: 5h=${five_hour_util}% 7d=${seven_day_util}%"
}

main() {
    log "OpenCode Usage Daemon started"
    
    while true; do
        fetch_usage
        sleep $FETCH_INTERVAL
    done
}

main
